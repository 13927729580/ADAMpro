syntax = "proto3";

package ch.unibas.dmi.dbis.adam.http.grpc;

service AdamDefinition {
  rpc CreateEntity(EntityNameMessage) returns (AckMessage) {}
  rpc DropEntity(EntityNameMessage) returns (AckMessage) {}
  rpc Insert(InsertMessage) returns (AckMessage) {}
  rpc Index(IndexMessage) returns (AckMessage) {}
  rpc DropIndex(IndexNameMessage) returns (AckMessage) {}
  rpc Count(EntityNameMessage) returns (AckMessage) {}
}

service AdamSearch {
  rpc DoStandardQuery(SimpleQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoSequentialQuery(SimpleSequentialQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoIndexQuery(SimpleIndexQueryMessage) returns (QueryResponseListMessage) {}
  rpc DoTimedProgressiveQuery(TimedQueryMessage) returns (QueryResponseListMessage) {}
}

service AdamSearchStreaming {
  rpc DoProgressiveQuery(SimpleQueryMessage) returns (QueryResponseListMessage) {}
}

message EntityNameMessage {
  string entity = 1;
}

message IndexNameMessage {
  string entity = 1;
}

message AckMessage {
  enum Code {
    OK = 0;
    ERROR = 1;
  }
  Code code = 1;
  string message = 2;
}

//insert and update (if id exists already)
message InsertMessage {
  string entity = 1;
  int64 id = 2;
  repeated float vector = 3 [packed=true];
  map<string, string> metadata = 4;
}

message IndexMessage {
  string entity = 1;
  enum Type {
    lsh = 0;
    sh = 1;
    ecp = 2;
    va = 3;
  }
  Type type = 2;
  map<string, string> options = 3;
}

message SimpleQueryMessage {
  string entity = 1;
  repeated float query = 2 [packed=true];
  int32 k = 3;
  map<string, string> metadata = 4;
  string hint = 5;
}

message SimpleSequentialQueryMessage {
  string entity = 1;
  repeated float query = 2 [packed=true];
  int32 k = 3;
  map<string, string> metadata = 4;
}

message SimpleIndexQueryMessage {
  string index = 1;
  repeated float query = 2 [packed=true];
  int32 k = 3;
  map<string, string> metadata = 4;
}

message TimedQueryMessage {
  string entity = 1;
  repeated float query = 2 [packed=true];
  int32 k = 3;
  map<string, string> metadata = 4;
  int64 time = 5;
}

message QueryResponseMessage {
  int64 id = 1;
  double distance = 2;
  string metadata = 3;
}

message QueryResponseListMessage {
  repeated QueryResponseMessage responses = 1;
}